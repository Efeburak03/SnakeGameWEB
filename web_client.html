<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Snake Game</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, orientation=landscape">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #222;
            overflow: hidden;
        }
        #ui {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            inset: 0;
            z-index: 10;
            /* Arka planı bulanık ve görsel ile kapla */
            background: url('assets/Background.jpg') center center/cover no-repeat;
        }
        #ui::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(34,34,34,0.55);
            backdrop-filter: blur(6px);
            z-index: -1;
        }
        #ui h1 {
            margin-bottom: 32px;
            font-size: 2.8em;
            font-weight: 900;
            letter-spacing: 2px;
            color: #fff;
            text-shadow: 0 2px 12px #000a;
        }
        #ui input {
            margin-bottom: 12px;
            padding: 12px 24px;
            font-size: 1.3em;
            border-radius: 10px;
            border: 2px solid #444;
            outline: none;
            background: rgba(255,255,255,0.12);
            color: #fff;
            font-family: 'Segoe UI', Arial, sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            transition: border 0.2s, box-shadow 0.2s;
        }
        #ui input:focus {
            border: 2px solid #4caf50;
            box-shadow: 0 2px 12px #4caf5055;
        }
        #ui input.error {
            border: 2px solid #e53935;
        }
        #ui button {
            margin-bottom: 8px;
            padding: 12px 32px;
            font-size: 1.2em;
            border-radius: 10px;
            border: none;
            background: linear-gradient(90deg, #4caf50 60%, #388e3c 100%);
            color: #fff;
            font-weight: bold;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.13);
            transition: background 0.2s, box-shadow 0.2s;
        }
        #ui button:hover, #ui button:focus {
            background: linear-gradient(90deg, #388e3c 60%, #4caf50 100%);
            box-shadow: 0 4px 16px #4caf5055;
        }
        #ui .error-msg {
            color: #e53935;
            font-size: 1.1em;
            margin-bottom: 10px;
            min-height: 24px;
            font-weight: 500;
            text-shadow: 0 1px 4px #000a;
        }
        #game-container {
            margin: 10px auto 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #game {
            background: #111;
            display: block;
            margin: 0 auto;
            border-radius: 12px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.25);
        }
        .game-message {
            position: absolute;
            left: 0; right: 0; top: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 100;
        }
        .game-message span {
            background: rgba(34,34,34,0.85);
            color: #fff;
            font-size: 2.5em;
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 24px 48px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        }
        #top-usernames {
            position: fixed;
            left: 160px;
            top: 0;
            width: calc(100vw - 160px);
            height: 48px;
            background: transparent;
            color: #fff;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            z-index: 15;
            font-size: 1.3em;
            font-family: 'Segoe UI', Arial, sans-serif;
            padding-left: 32px;
            gap: 48px;
            pointer-events: none;
        }
        #top-usernames span {
            background: rgba(34,34,34,0.45);
            border-radius: 8px;
            padding: 6px 18px;
            margin-right: 0;
            pointer-events: auto;
        }
        @media (max-width: 900px) {
            #touch-controls {
                display: flex !important;
            }
        }
        #touch-controls {
            display: none;
            position: fixed;
            bottom: 32px;
            right: 32px;
            left: auto;
            width: auto;
            flex-direction: row;
            justify-content: flex-end;
            align-items: flex-end;
            z-index: 1000;
            pointer-events: none;
        }
        .touch-btn {
            width: 56px;
            height: 56px;
            margin: 6px;
            border-radius: 50%;
            background: rgba(34,34,34,0.8);
            color: #fff;
            font-size: 2em;
            border: 2px solid #4caf50;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px #000a;
            pointer-events: auto;
            user-select: none;
            touch-action: manipulation;
        }
        .touch-btn:active {
            background: #4caf50;
            color: #fff;
        }
        .touch-btn-restart {
            background: #e53935;
            border: 2px solid #e53935;
            font-size: 1.5em;
            margin-left: 12px;
        }
        @media (orientation: portrait) {
            body {
                min-width: 100vw;
                min-height: 100vh;
                overflow: hidden;
            }
            #rotate-warning {
                display: flex !important;
            }
        }
        #rotate-warning {
            display: none;
            position: fixed;
            z-index: 20000;
            left: 0; top: 0; right: 0; bottom: 0;
            background: #222c;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 2em;
            text-align: center;
        }
        
        /* Mod ve Zorluk Seçimi Stilleri */
        #mode-ui, #difficulty-ui {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            inset: 0;
            z-index: 10;
            background: url('assets/Background.jpg') center center/cover no-repeat;
        }
        #mode-ui::before, #difficulty-ui::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(34,34,34,0.55);
            backdrop-filter: blur(6px);
            z-index: -1;
        }
        #mode-ui h1, #difficulty-ui h1 {
            margin-bottom: 32px;
            font-size: 2.8em;
            font-weight: 900;
            letter-spacing: 2px;
            color: #fff;
            text-shadow: 0 2px 12px #000a;
        }
        .mode-buttons, .difficulty-buttons {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }
        .mode-btn, .difficulty-btn {
            padding: 20px 30px;
            font-size: 1.2em;
            border-radius: 12px;
            border: 2px solid #444;
            background: rgba(255,255,255,0.1);
            color: #fff;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            min-width: 150px;
        }
        .mode-btn h3, .difficulty-btn h3 {
            margin: 0 0 10px 0;
            font-size: 1.3em;
            font-weight: bold;
        }
        .mode-btn p, .difficulty-btn p {
            margin: 0;
            font-size: 0.9em;
            opacity: 0.8;
        }
        .mode-btn:hover, .difficulty-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: #4caf50;
            transform: translateY(-2px);
        }
        .mode-btn.active, .difficulty-btn.active {
            background: #4caf50;
            border-color: #4caf50;
            color: #fff;
            transform: translateY(-2px);
        }
        
        /* Time Attack UI */
        #time-attack-ui {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        #time-attack-ui h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
        }
        #time-attack-ui div {
            margin: 5px 0;
            font-size: 1em;
        }
        #time-attack-ui button {
            margin-top: 10px;
            padding: 8px 16px;
            background: #4caf50;
            border: none;
            border-radius: 5px;
            color: #fff;
            cursor: pointer;
        }
        
        /* Capture the Flag UI */
        #ctf-ui {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: #fff;
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        #ctf-ui h3 {
            margin: 0 0 10px 0;
            font-size: 1.2em;
            color: #3498db;
        }
        #ctf-ui div {
            margin: 5px 0;
            font-size: 1em;
        }
        
        /* Takım Seçimi UI */
        #team-selection-ui {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            inset: 0;
            z-index: 10;
            background: url('assets/Background.jpg') center center/cover no-repeat;
        }
        #team-selection-ui::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(34,34,34,0.55);
            backdrop-filter: blur(6px);
            z-index: -1;
        }
        #team-selection-ui h1 {
            margin-bottom: 32px;
            font-size: 2.8em;
            font-weight: 900;
            letter-spacing: 2px;
            color: #fff;
            text-shadow: 0 2px 12px #000a;
        }
        .team-selection-container {
            display: flex;
            gap: 40px;
            margin-bottom: 30px;
            width: 100%;
            max-width: 800px;
            justify-content: center;
        }
        .team-area {
            flex: 1;
            max-width: 350px;
            position: relative;
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s;
        }
        .red-team-area {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.3) 0%, rgba(192, 57, 43, 0.3) 100%);
            border: 3px solid rgba(231, 76, 60, 0.5);
        }
        .blue-team-area {
            background: linear-gradient(135deg, rgba(52, 152, 219, 0.3) 0%, rgba(41, 128, 185, 0.3) 100%);
            border: 3px solid rgba(52, 152, 219, 0.5);
        }
        .team-area:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        }
        .team-info {
            padding: 20px;
            text-align: center;
            color: #fff;
        }
        .team-info h2 {
            margin: 0 0 10px 0;
            font-size: 1.8em;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }
        .team-info p {
            margin: 5px 0;
            font-size: 1.1em;
            opacity: 0.9;
        }
        .team-players {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        .team-players p {
            margin: 0;
            font-size: 1em;
            font-weight: bold;
        }
        .team-btn {
            width: 100%;
            padding: 15px 20px;
            font-size: 1.2em;
            border: none;
            border-radius: 0 0 12px 12px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            color: #fff;
            font-weight: bold;
        }
        .red-team-btn {
            background: linear-gradient(90deg, #e74c3c 60%, #c0392b 100%);
        }
        .red-team-btn:hover {
            background: linear-gradient(90deg, #c0392b 60%, #e74c3c 100%);
            transform: translateY(-2px);
        }
        .blue-team-btn {
            background: linear-gradient(90deg, #3498db 60%, #2980b9 100%);
        }
        .blue-team-btn:hover {
            background: linear-gradient(90deg, #2980b9 60%, #3498db 100%);
            transform: translateY(-2px);
        }
        .team-btn.active {
            box-shadow: 0 0 20px rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Kullanıcı Adı Ekranı -->
    <div id="ui">
        <h1>Snake Game</h1>
        <div class="error-msg" id="ui-error"></div>
        <input id="nicknameInput" type="text" maxlength="16" placeholder="Kullanıcı adı" />
        <button id="startBtn">Devam Et</button>
    </div>
    
    <!-- Mod Seçimi Ekranı -->
    <div id="mode-ui" style="display:none;">
        <h1>Oyun Modu Seçin</h1>
        <div class="error-msg" id="mode-error"></div>
        <div class="mode-buttons">
            <button class="mode-btn" data-mode="classic">
                <h3>Klasik Mod</h3>
                <p>Çok oyunculu rekabet</p>
            </button>
            <button class="mode-btn" data-mode="timeAttack">
                <h3>Time Attack</h3>
                <p>Solo zaman yarışı</p>
            </button>
            <button class="mode-btn" data-mode="captureTheFlag">
                <h3>Capture the Flag</h3>
                <p>Takım savaşı</p>
            </button>
        </div>
        <button id="modeStartBtn" style="display:none;">Oyunu Başlat</button>
    </div>
    
    <!-- Zorluk Seçimi Ekranı -->
    <div id="difficulty-ui" style="display:none;">
        <h1>Zorluk Seviyesi</h1>
        <div class="error-msg" id="difficulty-error"></div>
        <div class="difficulty-buttons">
            <button class="difficulty-btn" data-difficulty="easy">
                <h3>Kolay</h3>
                <p>2 dakika</p>
            </button>
            <button class="difficulty-btn" data-difficulty="medium">
                <h3>Orta</h3>
                <p>1.5 dakika</p>
            </button>
            <button class="difficulty-btn" data-difficulty="hard">
                <h3>Zor</h3>
                <p>1 dakika</p>
            </button>
        </div>
        <button id="difficultyStartBtn" style="display:none;">Oyunu Başlat</button>
    </div>
    
    <!-- Takım Seçimi Ekranı -->
    <div id="team-selection-ui" style="display:none;">
        <h1>Takım Seçin</h1>
        <div class="error-msg" id="team-error"></div>
        <div class="team-selection-container">
            <div class="team-area red-team-area">
                <div class="team-info">
                    <h2>Kırmızı Takım</h2>
                    <p>Sol taraf</p>
                    <div class="team-players" id="red-team-players">
                        <p>Oyuncular: 0</p>
                    </div>
                </div>
                <button class="team-btn red-team-btn" data-team="red">
                    <h3>Kırmızı Takım</h3>
                    <p>Sol taraf</p>
                </button>
            </div>
            <div class="team-area blue-team-area">
                <div class="team-info">
                    <h2>Mavi Takım</h2>
                    <p>Sağ taraf</p>
                    <div class="team-players" id="blue-team-players">
                        <p>Oyuncular: 0</p>
                    </div>
                </div>
                <button class="team-btn blue-team-btn" data-team="blue">
                    <h3>Mavi Takım</h3>
                    <p>Sağ taraf</p>
                </button>
            </div>
        </div>
        <button id="teamStartBtn" style="display:none;">Oyunu Başlat</button>
    </div>
    <div id="top-usernames" style="display:none;"></div>
    <div id="game-container" style="display:none; width:100vw; height:100vh;">
        <div style="position:relative; width:100vw; height:100vh;">
            <canvas id="game"></canvas>
            <div id="game-message" class="game-message" style="display:none;"><span></span></div>
        </div>
    </div>
    <div id="rotate-warning">Lütfen cihazınızı yatay konuma çevirin.<br/>Please rotate your device.</div>
    <div id="touch-controls">
        <div style="display:flex; flex-direction:column; align-items:center; justify-content:flex-end;">
            <button class="touch-btn" id="btn-up" style="margin-bottom:2px;">▲</button>
            <div style="display:flex; flex-direction:row; align-items:center;">
                <button class="touch-btn" id="btn-left">◀</button>
                <button class="touch-btn" id="btn-down" style="margin:0 2px;">▼</button>
                <button class="touch-btn" id="btn-right">▶</button>
            </div>
        </div>
        <button class="touch-btn touch-btn-restart" id="btn-restart" style="display:none; align-self:flex-end; margin-left:12px;">⟳</button>
    </div>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script>
    // --- Oyun parametreleri ---
    let BOARD_WIDTH = 60;
    let BOARD_HEIGHT = 35;
    let CELL_SIZE = 20; // Bu dinamik olacak
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    let socket = null;
    let myId = null;
    let gameState = null;
    let started = false;
    let readySent = false;
    let eliminationTime = null;
    let currentDirection = null; // Başlangıçta null
    let nickname = '';
    let assets = {};
    
    // Time Attack değişkenleri
    let timeAttackState = null;
    let currentGameMode = null;
    let currentDifficulty = null;
    
    // Capture the Flag değişkenleri
    let ctfGameState = null;
    let ctfTeam = null;
    let selectedTeam = null;

    // --- Görselleri yükle ---
    const assetFiles = {
        apple: 'assets/elma.png',
        golden: 'assets/golden_apple.png',
        grass: 'assets/çimen.png',
        box: 'assets/kutu.png',
        portal: 'assets/portal.png',
        bg: 'assets/Background.jpg',
        eagle: 'assets/Eagle_500kg.png',
    };
    function loadAssets(cb) {
        let loaded = 0, total = Object.keys(assetFiles).length;
        for (const [key, src] of Object.entries(assetFiles)) {
            const img = new Image();
            img.onload = () => { assets[key] = img; if (++loaded === total) cb(); };
            img.onerror = () => { loaded++; if (loaded === total) cb(); };
            img.src = src;
        }
    }

    // --- WebSocket bağlantısı ---
    function connect() {
        socket = io();
        socket.on('connect', () => {
            console.log('[DEBUG] connect: Bağlantı kuruldu, mod:', currentGameMode);
            if (currentGameMode === 'timeAttack') {
                socket.emit('start_time_attack', {client_id: nickname, difficulty: currentDifficulty});
            } else if (currentGameMode === 'captureTheFlag') {
                socket.emit('start_capture_the_flag', {client_id: nickname});
                socket.emit('ctf_join', {client_id: nickname, nickname: nickname, team: selectedTeam});
            } else if (currentGameMode === 'classic') {
                socket.emit('join', {client_id: nickname});
            } else {
                console.log('[DEBUG] connect: Bilinmeyen mod:', currentGameMode);
            }
        });
        
        socket.on('state', (state) => {
            console.log('[DEBUG] Klasik mod state geldi:', state);
            gameState = state;
            if (!myId) myId = nickname;
            // Oyun durumu değiştiğinde readySent'i sıfırla
            readySent = false;
            
            // Sadece klasik mod için draw() çağır
            if (currentGameMode === 'classic') {
                draw();
            }
            
            updateTopUsernames();
            updateRestartButton();
        });
        
        // Time Attack event listener'ları
        socket.on('time_attack_started', (data) => {
            console.log('[DEBUG] Time Attack başladı:', data);
            currentGameMode = 'timeAttack';
            currentDifficulty = data.difficulty;
            showTimeAttackUI();
        });
        
        socket.on('time_attack_state', (state) => {
            console.log('[DEBUG] Time Attack state geldi:', state);
            console.log('[DEBUG] Power-up sayısı:', state.powerups ? state.powerups.length : 0);
            if (state.powerups && state.powerups.length > 0) {
                console.log('[DEBUG] Power-up\'lar:', state.powerups);
            }
            timeAttackState = state;
            // Eğer oyun aktifse canlanma mesajını gizle
            if (state.game_active) {
                hideRespawnMessage();
            }
            
            // Sadece Time Attack modu için drawTimeAttack() çağır
            if (currentGameMode === 'timeAttack') {
                drawTimeAttack();
            }
        });
        
        // Capture the Flag event listener'ları
        socket.on('capture_the_flag_started', (data) => {
            console.log('[DEBUG] CTF başladı:', data);
            currentGameMode = 'captureTheFlag';
            showCTFUI();
            startCTFUITimer(); // UI timer'ını başlat
        });
        
        socket.on('ctf_joined', (data) => {
            console.log('[DEBUG] CTF\'ye katıldı:', data);
            ctfGameState = data.game_state;
            ctfTeam = data.team;
            
            // Sadece CTF modu için drawCTF() çağır
            if (currentGameMode === 'captureTheFlag') {
                drawCTF();
            }
        });
        
        socket.on('ctf_state', (state) => {
            console.log('[DEBUG] CTF state geldi:', state);
            ctfGameState = state;
            
            // Sadece CTF modu için drawCTF() çağır
            if (currentGameMode === 'captureTheFlag') {
                drawCTF();
            }
        });
        
        socket.on('ctf_game_over', (data) => {
            console.log('[DEBUG] CTF oyunu bitti:', data);
            showCTFResult(data);
        });
        
        socket.on('ctf_respawned', (data) => {
            console.log('[DEBUG] CTF respawn:', data);
            // Respawn butonunu gizle
            const respawnBtn = document.getElementById('ctf-respawn-btn');
            if (respawnBtn) {
                respawnBtn.style.display = 'none';
            }
        });
        
        socket.on('ctf_game_restarted', (data) => {
            console.log('[DEBUG] CTF oyunu yeniden başlatıldı:', data);
            // Oyun yeniden başlatıldığında state'i temizle
            ctfGameState = null;
            // UI'ı güncelle
            if (currentGameMode === 'captureTheFlag') {
                drawCTF();
            }
        });
        
        socket.on('ctf_flag_delivered', (data) => {
            console.log('[DEBUG] CTF bayrak teslim edildi:', data);
            // Bayrak teslim edildiğinde bildirim göster
            alert('Bayrak teslim edildi! Oyun yeniden başlatılıyor...');
            // Kısa bir süre sonra oyunu yeniden başlat
            setTimeout(() => {
                if (socket && socket.connected) {
                    socket.emit('ctf_restart', {client_id: myId});
                }
            }, 2000);
        });
        
        socket.on('ctf_round_won', (data) => {
            console.log('[DEBUG] CTF round kazanıldı:', data);
            // Round kazanıldığında bildirim göster
            const winningTeam = data.winning_team === 'red' ? 'Kırmızı Takım' : 'Mavi Takım';
            alert(`${winningTeam} round'u kazandı! Oyun yeniden başlatılıyor...`);
            // Kısa bir süre sonra oyunu yeniden başlat
            setTimeout(() => {
                if (socket && socket.connected) {
                    socket.emit('ctf_restart', {client_id: myId});
                }
            }, 3000);
        });
        
        socket.on('error', (err) => {
            const errorDiv = document.getElementById('ui-error');
            errorDiv.textContent = err.message || 'Bağlantı hatası!';
            document.getElementById('ui').style.display = 'flex';
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('top-usernames').style.display = 'none';
        });
        
        socket.on('disconnect', () => {
            setTimeout(connect, 1000);
        });
        
        socket.on('ctf_respawn_failed', (data) => {
            console.log('[DEBUG] CTF respawn failed:', data);
            // Kalan süreyi göster
            const remainingTime = data.remaining_time;
            alert(`Henüz respawn olamazsın! ${remainingTime.toFixed(1)} saniye daha bekle.`);
        });
    }

    // --- Oyun çizimi ---
    function draw() {
        console.log('[DEBUG] draw: Klasik mod çiziliyor');
        
        // Canvas'ı tamamen temizle
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Sadece klasik mod için arka plan
        if (assets.bg) {
            const pattern = ctx.createPattern(assets.bg, 'repeat');
            ctx.save();
            ctx.fillStyle = pattern;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.restore();
        } else if (assets.grass) {
            const pattern = ctx.createPattern(assets.grass, 'repeat');
            ctx.save();
            ctx.fillStyle = pattern;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.restore();
        } else {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        
        if (!gameState) {
            console.log('[DEBUG] draw: gameState yok');
            return;
        }
        
        console.log('[DEBUG] draw: Klasik mod state var');
        
        // Yılanlar
        if (gameState.snakes) {
            console.log('[DEBUG] draw: Yılanlar çiziliyor, sayı:', Object.keys(gameState.snakes).length);
            for (const [pid, snake] of Object.entries(gameState.snakes)) {
                let frozen = false;
                if (gameState.powerup_timers && gameState.powerup_timers[pid] && gameState.powerup_timers[pid]["frozen"] > 0) frozen = true;
                ctx.fillStyle = frozen ? '#888' : (pid === myId ? 'lime' : 'yellow');
                for (const [i, seg] of snake.entries()) {
                    ctx.fillRect(seg[0]*CELL_SIZE, seg[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                }
            }
        } else {
            console.log('[DEBUG] draw: Yılan yok');
        }
        
        // İzler (trails)
        if (gameState.trails) {
            for (const [pid, trail] of Object.entries(gameState.trails)) {
                // İzler için sabit turkuaz yarı saydam renk
                let color = 'rgba(0,255,200,0.5)';
                ctx.save();
                ctx.globalAlpha = 0.5;
                ctx.fillStyle = color;
                for (const seg of trail) {
                    ctx.fillRect(seg[0]*CELL_SIZE, seg[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                }
                ctx.restore();
            }
        }
        
        // Engeller (yılanlardan sonra çiz)
        if (gameState.obstacles) {
            for (const obs of gameState.obstacles) {
                const [ox, oy] = obs.pos;
                const size = CELL_SIZE * 1.5;
                const offset = (size - CELL_SIZE) / 2;
                if (obs.type === 'slow' && assets.grass) ctx.drawImage(assets.grass, ox*CELL_SIZE - offset, oy*CELL_SIZE - offset, size, size);
                else if (obs.type === 'poison' && assets.box) ctx.drawImage(assets.box, ox*CELL_SIZE - offset, oy*CELL_SIZE - offset, size, size);
                else if (obs.type === 'hidden_wall') {
                    // Gizli duvarlar yılanın başının 4 blok yakınında görünür
                    let show = false;
                    if (gameState.snakes && myId && gameState.snakes[myId] && gameState.snakes[myId].length > 0) {
                        const [hx, hy] = gameState.snakes[myId][0];
                        const dist = Math.abs(hx - ox) + Math.abs(hy - oy);
                        if (dist <= 4) show = true;
                    }
                    if (show) {
                        ctx.fillStyle = '#555';
                        ctx.fillRect(ox*CELL_SIZE, oy*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    }
                }
            }
        }
        
        // Portallar
        if (gameState.portals) {
            for (const [a, b] of gameState.portals) {
                if (assets.portal) {
                    const size = CELL_SIZE * 1.2;
                    const offset = (size - CELL_SIZE) / 2;
                    ctx.drawImage(assets.portal, a[0]*CELL_SIZE - offset, a[1]*CELL_SIZE - offset, size, size);
                    ctx.drawImage(assets.portal, b[0]*CELL_SIZE - offset, b[1]*CELL_SIZE - offset, size, size);
                } else {
                    ctx.fillStyle = '#80f';
                    ctx.fillRect(a[0]*CELL_SIZE, a[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    ctx.fillRect(b[0]*CELL_SIZE, b[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                }
            }
        }
        
        // Yemler
        if (gameState.food) {
            console.log('[DEBUG] draw: Yemler çiziliyor, sayı:', gameState.food.length);
            for (const [fx, fy] of gameState.food) {
                if (assets.apple) {
                    const size = CELL_SIZE * 1.2;
                    const offset = (size - CELL_SIZE) / 2;
                    ctx.drawImage(assets.apple, fx*CELL_SIZE - offset, fy*CELL_SIZE - offset, size, size);
                } else { 
                    ctx.fillStyle = 'red'; 
                    ctx.fillRect(fx*CELL_SIZE, fy*CELL_SIZE, CELL_SIZE, CELL_SIZE); 
                }
            }
        } else {
            console.log('[DEBUG] draw: Yem yok');
        }
        
        // Altın elma
        if (gameState.golden_food) {
            const [gx, gy] = gameState.golden_food;
            if (assets.golden) ctx.drawImage(assets.golden, gx*CELL_SIZE, gy*CELL_SIZE, CELL_SIZE, CELL_SIZE);
            else { 
                ctx.fillStyle = 'gold'; 
                ctx.beginPath(); 
                ctx.arc(gx*CELL_SIZE+CELL_SIZE/2, gy*CELL_SIZE+CELL_SIZE/2, CELL_SIZE/2, 0, 2*Math.PI); 
                ctx.fill(); 
            }
        }
        
        // Kalan süre
        if (gameState.time_left !== undefined) {
            ctx.fillStyle = 'yellow';
            ctx.font = '24px Arial';
            ctx.fillText('Süre: ' + (gameState.time_left||0) + ' sn', canvas.width/2-60, 30);
        }
        
        // Oyun mesajı gösterimi
        const msgDiv = document.getElementById('game-message');
        if (gameState.active && myId && !gameState.active[myId]) {
            msgDiv.style.display = 'flex';
            msgDiv.querySelector('span').textContent = 'Elenedin! Devam için Enter';
        } else if (gameState.waiting_for_restart) {
            msgDiv.style.display = 'flex';
            let winnerName = gameState.winner_id;
            let winnerScore = gameState.scores && winnerName ? gameState.scores[winnerName] : '';
            if (!winnerName || winnerName === '-') winnerName = 'Yok';
            msgDiv.querySelector('span').textContent =
                'Oyun Bitti! Kazanan: ' + winnerName + (winnerScore !== '' ? ' (' + winnerScore + ' puan)' : '') + '\n' +
                'Devam için Enter (tüm oyuncular)';
        } else {
            msgDiv.style.display = 'none';
        }
        
        // Power-up'lar
        if (gameState.powerups) {
            for (const pu of gameState.powerups) {
                const [x, y] = pu.pos;
                let color = '#ccc';
                if (pu.type === 'speed') color = 'blue';
                else if (pu.type === 'shield') color = 'black';
                else if (pu.type === 'invisible') color = 'gray';
                else if (pu.type === 'reverse') color = 'white';
                else if (pu.type === 'freeze') color = '#00c8ff';
                else if (pu.type === 'giant') color = 'orange';
                else if (pu.type === 'magnet') color = 'purple';
                else if (pu.type === 'trail') color = '#00e6e6'; // Trail power-up için turkuaz
                ctx.beginPath();
                ctx.arc(x*CELL_SIZE+CELL_SIZE/2, y*CELL_SIZE+CELL_SIZE/2, CELL_SIZE/2.2, 0, 2*Math.PI);
                ctx.fillStyle = color;
                ctx.fill();
            }
        }
    }

    // --- Skor tablosu ---
    function updateScoreboard() { /* Artık kullanılmıyor */ }

    function updateTopUsernames() {
        const topDiv = document.getElementById('top-usernames');
        if (!gameState || !gameState.scores) { topDiv.innerHTML = ''; return; }
        let html = '';
        for (const pid of Object.keys(gameState.scores)) {
            html += `<span>${pid}: ${gameState.scores[pid]}</span>`;
        }
        topDiv.innerHTML = html;
    }

    // --- Dinamik boyutlandırma fonksiyonu ---
    function resizeGameCanvas() {
        const w = window.innerWidth;
        const h = window.innerHeight;
        CELL_SIZE = Math.floor(Math.min(w / BOARD_WIDTH, h / BOARD_HEIGHT));
        canvas.width = CELL_SIZE * BOARD_WIDTH;
        canvas.height = CELL_SIZE * BOARD_HEIGHT;
        
        console.log('[DEBUG] resizeGameCanvas: Window boyutları:', w, 'x', h);
        console.log('[DEBUG] resizeGameCanvas: CELL_SIZE:', CELL_SIZE);
        console.log('[DEBUG] resizeGameCanvas: Canvas boyutları:', canvas.width, 'x', canvas.height);
        console.log('[DEBUG] resizeGameCanvas: Mevcut mod:', currentGameMode);
        
        // Eğer oyun başladıysa çiz
        if (started) {
            console.log('[DEBUG] resizeGameCanvas: Oyun başladı, çizim yapılıyor');
            
            // Her mod kendi çizim fonksiyonunu çağırsın
            if (currentGameMode === 'timeAttack' && timeAttackState) {
                console.log('[DEBUG] resizeGameCanvas: Time Attack modu çiziliyor');
                drawTimeAttack();
            } else if (currentGameMode === 'captureTheFlag' && ctfGameState) {
                console.log('[DEBUG] resizeGameCanvas: CTF modu çiziliyor');
                drawCTF();
            } else if (currentGameMode === 'classic' && gameState) {
                console.log('[DEBUG] resizeGameCanvas: Klasik mod çiziliyor');
                draw();
            } else {
                console.log('[DEBUG] resizeGameCanvas: Mod belirlenemedi veya state yok');
                console.log('[DEBUG] resizeGameCanvas: currentGameMode:', currentGameMode);
                console.log('[DEBUG] resizeGameCanvas: timeAttackState:', timeAttackState);
                console.log('[DEBUG] resizeGameCanvas: ctfGameState:', ctfGameState);
                console.log('[DEBUG] resizeGameCanvas: gameState:', gameState);
            }
        } else {
            console.log('[DEBUG] resizeGameCanvas: Oyun henüz başlamadı');
        }
    }
    window.addEventListener('resize', resizeGameCanvas);
    window.addEventListener('orientationchange', resizeGameCanvas);
    window.addEventListener('DOMContentLoaded', resizeGameCanvas);
    // --- Tam ekran butonu kaldırıldı ---
    // window.addEventListener('resize', resizeGameCanvas);
    // --- Oyun başlatıldığında canvas'ı tam ekran boyutla ---
    document.getElementById('startBtn').onclick = startGame;
    document.getElementById('nicknameInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') startGame();
    });
    function startGame() {
        // Kullanıcı adını input'tan tekrar al
        const input = document.getElementById('nicknameInput');
        nickname = input.value.trim();
        // Matrix mode kontrolü
        if (nickname && ['matrix','neo','admin'].includes(nickname.toLowerCase())) {
            startMatrixRain();
        } else {
            stopMatrixRain();
        }
        const errorDiv = document.getElementById('ui-error');
        input.classList.remove('error');
        errorDiv.textContent = '';
        if (!nickname) {
            errorDiv.textContent = 'Kullanıcı adı gir!';
            input.classList.add('error');
            return;
        }
        if (nickname.length > 8) {
            errorDiv.textContent = 'Kullanıcı adı en fazla 8 karakter olmalı!';
            input.classList.add('error');
            return;
        }
        
        // Mod seçimi ekranına geç
        document.getElementById('ui').style.display = 'none';
        document.getElementById('mode-ui').style.display = 'flex';
    }
    
    function selectMode() {
        const modeSelection = document.querySelector('.mode-btn.active');
        
        if (!modeSelection) {
            document.getElementById('mode-error').textContent = 'Lütfen bir oyun modu seçin!';
            return;
        }
        
        currentGameMode = modeSelection.dataset.mode;
        
        if (currentGameMode === 'timeAttack') {
            // Zorluk seçimi ekranına geç
            document.getElementById('mode-ui').style.display = 'none';
            document.getElementById('difficulty-ui').style.display = 'flex';
        } else if (currentGameMode === 'captureTheFlag') {
            // CTF modu için takım seçimi ekranına geç
            document.getElementById('mode-ui').style.display = 'none';
            document.getElementById('team-selection-ui').style.display = 'flex';
            updateTeamSelectionUI();
        } else {
            // Klasik mod için direkt oyunu başlat
            startGameMode();
        }
    }
    
    function selectDifficulty() {
        const difficultySelection = document.querySelector('.difficulty-btn.active');
        
        if (!difficultySelection) {
            document.getElementById('difficulty-error').textContent = 'Lütfen bir zorluk seviyesi seçin!';
            return;
        }
        
        currentDifficulty = difficultySelection.dataset.difficulty;
        startGameMode();
    }
    
    function selectTeam() {
        const teamSelection = document.querySelector('.team-btn.active');
        
        if (!teamSelection) {
            document.getElementById('team-error').textContent = 'Lütfen bir takım seçin!';
            return;
        }
        
        selectedTeam = teamSelection.dataset.team;
        startGameMode();
    }
    
    function updateTeamSelectionUI() {
        // Takım seçimi UI'ını güncelle (oyuncu sayılarını göster)
        // Bu fonksiyon gerçek zamanlı olarak güncellenebilir
        const redTeamPlayers = document.getElementById('red-team-players');
        const blueTeamPlayers = document.getElementById('blue-team-players');
        
        if (redTeamPlayers) {
            redTeamPlayers.innerHTML = '<p>Oyuncular: 0</p>';
        }
        if (blueTeamPlayers) {
            blueTeamPlayers.innerHTML = '<p>Oyuncular: 0</p>';
        }
    }
    
    function startGameMode() {
        document.getElementById('mode-ui').style.display = 'none';
        document.getElementById('difficulty-ui').style.display = 'none';
        document.getElementById('team-selection-ui').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        document.getElementById('top-usernames').style.display = 'flex';
        started = true;
        currentDirection = null;
        
        // Klasik mod için currentGameMode'u ayarla
        if (!currentGameMode || currentGameMode === 'classic') {
            currentGameMode = 'classic';
        }
        
        console.log('[DEBUG] startGameMode: Başlatılan mod:', currentGameMode);
        
        // Canvas'ı boyutlandır
        resizeGameCanvas();
        console.log('[DEBUG] startGameMode: Canvas boyutlandırıldı');
        console.log('[DEBUG] startGameMode: Canvas boyutları:', canvas.width, 'x', canvas.height);
        
        // Bağlantıyı kur
        connect();
    }

    // Easter egg: yukarı, sağ, aşağı, aşağı, aşağı kombinasyonu
    const easterEggSequence = ['ArrowUp', 'ArrowRight', 'ArrowDown', 'ArrowDown', 'ArrowDown'];
    let easterEggProgress = 0;
    document.addEventListener('keydown', (e) => {
        if (!started || !socket || socket.disconnected) return;
        if (!myId) return;
        if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
            e.preventDefault();
        }
        if (e.repeat) return; // Sadece ilk basışta çalışsın, basılı tutunca ilerlemesin
        
        // Time Attack modu için
        if (currentGameMode === 'timeAttack') {
            if (e.key === 'ArrowUp') sendTimeAttackMove('UP');
            else if (e.key === 'ArrowDown') sendTimeAttackMove('DOWN');
            else if (e.key === 'ArrowLeft') sendTimeAttackMove('LEFT');
            else if (e.key === 'ArrowRight') sendTimeAttackMove('RIGHT');
            else if (e.key === 'Enter') {
                if (socket && socket.connected) {
                    socket.emit('time_attack_respawn', {client_id: myId});
                    // Canlanma mesajını hemen gizle
                    hideRespawnMessage();
                }
            }
        } else if (currentGameMode === 'captureTheFlag') {
            // CTF modu için
            if (e.key === 'ArrowUp') sendCTFMove('UP');
            else if (e.key === 'ArrowDown') sendCTFMove('DOWN');
            else if (e.key === 'ArrowLeft') sendCTFMove('LEFT');
            else if (e.key === 'ArrowRight') sendCTFMove('RIGHT');
            else if (e.key === 'Enter') {
                // CTF'de Enter ile respawn
                if (socket && socket.connected) {
                    socket.emit('ctf_respawn', {client_id: myId});
                }
            }
        } else {
            // Klasik mod için
            if (e.key === 'ArrowUp') sendMove('UP');
            else if (e.key === 'ArrowDown') sendMove('DOWN');
            else if (e.key === 'ArrowLeft') sendMove('LEFT');
            else if (e.key === 'ArrowRight') sendMove('RIGHT');
            else if (e.key === 'Enter') {
                hideEagleEggScreen();
                if (gameState && gameState.active && !gameState.active[myId]) {
                    socket.emit('restart', {client_id: myId});
                    // Mesajı hemen gizle
                    const msgDiv = document.getElementById('game-message');
                    msgDiv.style.display = 'none';
                } else if (gameState && gameState.waiting_for_restart) {
                    if (!readySent) {
                        socket.emit('ready', {client_id: myId});
                        readySent = true;
                    }
                }
            }
        }
        
        // Easter egg kontrolü (her iki modda da çalışır)
        if (e.key === easterEggSequence[easterEggProgress]) {
            easterEggProgress++;
            if (easterEggProgress === easterEggSequence.length) {
                // PNG'yi hemen ekrana getir
                showEagleEggScreen();
                // Sunucuya özel mesaj gönder
                if (socket && socket.connected) {
                    socket.emit('easteregg', {client_id: myId});
                }
                easterEggProgress = 0;
            }
        } else {
            easterEggProgress = 0;
        }
    });

    // --- Mesaj gönderme fonksiyonları ---
    function sendMove(dir) {
        if (!myId) return;
        if (currentDirection && dir === currentDirection) return;
        socket.emit('move', {client_id: myId, direction: dir});
        currentDirection = dir;
    }
    
    // Mod ve zorluk seçimi event listener'ları
    document.addEventListener('DOMContentLoaded', () => {
        // Mod seçimi
        document.querySelectorAll('.mode-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('modeStartBtn').style.display = 'inline-block';
            });
        });
        
        // Zorluk seçimi
        document.querySelectorAll('.difficulty-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById('difficultyStartBtn').style.display = 'inline-block';
            });
        });
        
        // Kullanıcı adı ekranı başlat butonu
        document.getElementById('startBtn').addEventListener('click', startGame);
        
        // Mod seçimi başlat butonu
        document.getElementById('modeStartBtn').addEventListener('click', selectMode);
        
        // Zorluk seçimi başlat butonu
        document.getElementById('difficultyStartBtn').addEventListener('click', selectDifficulty);
        
        // Takım seçimi butonları
        document.querySelectorAll('.team-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Önceki seçimi temizle
                document.querySelectorAll('.team-btn').forEach(b => b.classList.remove('active'));
                // Yeni seçimi işaretle
                this.classList.add('active');
                document.getElementById('teamStartBtn').style.display = 'inline-block';
            });
        });
        
        // Takım seçimi başlat butonu
        document.getElementById('teamStartBtn').addEventListener('click', selectTeam);
    });

    // Eagle easter egg görseli için asset yükle
    assets.eagle = new Image();
    assets.eagle.src = 'assets/Eagle_500kg.png';

    function showEagleEggScreen() {
        let overlay = document.getElementById('eagle-egg-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'eagle-egg-overlay';
            overlay.style.position = 'fixed';
            overlay.style.left = '0';
            overlay.style.top = '0';
            overlay.style.width = '100vw';
            overlay.style.height = '100vh';
            overlay.style.background = 'rgba(0,0,0,0.7)';
            overlay.style.display = 'flex';
            overlay.style.flexDirection = 'column';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.zIndex = '99999';
            document.body.appendChild(overlay);
        }
        overlay.innerHTML = '';
        const img = document.createElement('img');
        img.src = assets.eagle && assets.eagle.src ? assets.eagle.src : 'assets/Eagle_500kg.png';
        img.alt = 'Eagle Easter Egg';
        img.style.width = '220px';
        img.style.maxWidth = '90vw';
        img.style.maxHeight = '90vh';
        img.onerror = function() {
            console.error('[DEBUG] Eagle PNG yüklenemedi:', img.src);
            overlay.innerHTML = '<div style="color:white;font-size:2em;">Eagle PNG yüklenemedi! (' + img.src + ')</div>';
        };
        img.onload = function() {
            console.log('[DEBUG] Eagle PNG yüklendi:', img.src);
        };
        overlay.appendChild(img);
        overlay.style.display = 'flex';
        overlay.style.visibility = 'visible';
        overlay.style.opacity = '1';
        console.log('[DEBUG] Eagle overlay gösterildi', img.src, overlay);
    }

    // Oyuncu yeniden başlatınca eagle overlay'i kapat
    function hideEagleEggScreen() {
        const overlay = document.getElementById('eagle-egg-overlay');
        if (overlay) overlay.style.display = 'none';
    }

    // Matrix yağmuru için canvas'ı body'nin en başına ekle
    let matrixCanvas = document.getElementById('matrix-bg');
    if (!matrixCanvas) {
        matrixCanvas = document.createElement('canvas');
        matrixCanvas.id = 'matrix-bg';
        matrixCanvas.style.position = 'fixed';
        matrixCanvas.style.left = '0';
        matrixCanvas.style.top = '0';
        matrixCanvas.style.width = '100vw';
        matrixCanvas.style.height = '100vh';
        matrixCanvas.style.pointerEvents = 'none';
        matrixCanvas.style.zIndex = '0'; // EN ARKADA!
        document.body.insertBefore(matrixCanvas, document.body.firstChild);
    }
    // Oyun canvası ve UI elementlerinin z-index'i 1 veya daha yüksek olmalı
    const gameCanvas = document.getElementById('game');
    if (gameCanvas) gameCanvas.style.zIndex = '1';
    const topUsernames = document.getElementById('top-usernames');
    if (topUsernames) topUsernames.style.zIndex = '2';
    const gameContainer = document.getElementById('game-container');
    if (gameContainer) gameContainer.style.zIndex = '2';

    let matrixAnimId = null;
    function startMatrixRain() {
        const c = matrixCanvas;
        const ctx = c.getContext('2d');
        c.width = window.innerWidth;
        c.height = window.innerHeight;
        const letters = '10'; // Sadece 1 ve 0 karakterleri
        const fontSize = 18;
        const columns = Math.floor(c.width / fontSize);
        const drops = Array(columns).fill(1);
        function drawMatrix() {
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            ctx.fillRect(0, 0, c.width, c.height);
            ctx.font = fontSize + 'px monospace';
            ctx.fillStyle = '#0F0';
            for (let i = 0; i < drops.length; i++) {
                const text = letters[Math.floor(Math.random() * letters.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > c.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
            matrixAnimId = requestAnimationFrame(drawMatrix);
        }
        drawMatrix();
        window.addEventListener('resize', resizeMatrixCanvas);
        function resizeMatrixCanvas() {
            c.width = window.innerWidth;
            c.height = window.innerHeight;
        }
    }
    function stopMatrixRain() {
        if (matrixAnimId) cancelAnimationFrame(matrixAnimId);
        const ctx = matrixCanvas.getContext('2d');
        ctx.clearRect(0, 0, matrixCanvas.width, matrixCanvas.height);
    }

    // startGame fonksiyonunun başında nickname kontrolüyle animasyonu başlat/durdur
    const origStartGame = startGame;
    startGame = function() {
        if (nickname && ['matrix','neo','admin'].includes(nickname.trim().toLowerCase())) {
            startMatrixRain();
        } else {
            stopMatrixRain();
        }
        origStartGame.apply(this, arguments);
    };

    // Oyun bitince veya sayfa kapanınca animasyonu durdur
    window.addEventListener('beforeunload', stopMatrixRain);

    // Dokunmatik yön tuşları
    function setupTouchControls() {
        const up = document.getElementById('btn-up');
        const down = document.getElementById('btn-down');
        const left = document.getElementById('btn-left');
        const right = document.getElementById('btn-right');
        const restart = document.getElementById('btn-restart');
        if (!up) return;
        
        // Touch kontroller için eagle easter egg kontrolü
        function checkEasterEgg(key) {
            if (key === easterEggSequence[easterEggProgress]) {
                easterEggProgress++;
                if (easterEggProgress === easterEggSequence.length) {
                    // PNG'yi hemen ekrana getir
                    showEagleEggScreen();
                    // Sunucuya özel mesaj gönder
                    if (socket && socket.connected) {
                        socket.emit('easteregg', {client_id: myId});
                    }
                    easterEggProgress = 0;
                }
            } else {
                easterEggProgress = 0;
            }
        }
        
        up.addEventListener('touchstart', e => { 
            e.preventDefault(); 
            checkEasterEgg('ArrowUp');
            if (currentGameMode === 'timeAttack') {
                sendTimeAttackMove('UP');
            } else {
                sendMove('UP');
            }
        });
        down.addEventListener('touchstart', e => { 
            e.preventDefault(); 
            checkEasterEgg('ArrowDown');
            if (currentGameMode === 'timeAttack') {
                sendTimeAttackMove('DOWN');
            } else {
                sendMove('DOWN');
            }
        });
        left.addEventListener('touchstart', e => { 
            e.preventDefault(); 
            checkEasterEgg('ArrowLeft');
            if (currentGameMode === 'timeAttack') {
                sendTimeAttackMove('LEFT');
            } else {
                sendMove('LEFT');
            }
        });
        right.addEventListener('touchstart', e => { 
            e.preventDefault(); 
            checkEasterEgg('ArrowRight');
            if (currentGameMode === 'timeAttack') {
                sendTimeAttackMove('RIGHT');
            } else {
                sendMove('RIGHT');
            }
        });
        if (restart) {
            restart.addEventListener('touchstart', e => {
                e.preventDefault();
                if (myId && gameState && gameState.active && !gameState.active[myId]) {
                    socket.emit('restart', {client_id: myId});
                } else if (gameState && gameState.waiting_for_restart) {
                    if (!readySent) {
                        socket.emit('ready', {client_id: myId});
                        readySent = true;
                    }
                }
            });
        }
        // Masaüstünde görünmesin, mobilde görünsün
        function updateTouchControlsVisibility() {
            const controls = document.getElementById('touch-controls');
            if (window.innerWidth < 900 || /Android|iPhone|iPad|iPod|Opera Mini|IEMobile|WPDesktop/i.test(navigator.userAgent)) {
                controls.style.display = 'flex';
            } else {
                controls.style.display = 'none';
            }
        }
        window.addEventListener('resize', updateTouchControlsVisibility);
        updateTouchControlsVisibility();
    }
    window.addEventListener('DOMContentLoaded', setupTouchControls);

    // Ekran dikeyse uyarı göster
    function checkOrientation() {
        const warning = document.getElementById('rotate-warning');
        if (window.innerWidth < window.innerHeight) {
            warning.style.display = 'flex';
        } else {
            warning.style.display = 'none';
        }
    }
    window.addEventListener('resize', checkOrientation);
    window.addEventListener('orientationchange', checkOrientation);
    window.addEventListener('DOMContentLoaded', checkOrientation);

    // Time Attack fonksiyonları
    function showTimeAttackUI() {
        const existingUI = document.getElementById('time-attack-ui');
        if (existingUI) {
            existingUI.remove();
        }
        
        const ui = document.createElement('div');
        ui.id = 'time-attack-ui';
        ui.innerHTML = `
            <h3>Time Attack</h3>
            <div id="time-display">Süre: <span id="time-left">--</span></div>
            <div id="score-display">Skor: <span id="score">0</span></div>
            <div id="respawn-display">Canlanma: <span id="respawn-count">0</span></div>
            <span id="difficulty-display">Zorluk: --</span>
            <button id="respawn-btn">Canlan</button>
        `;
        document.body.appendChild(ui);
        
        // Canlanma butonu event listener
        document.getElementById('respawn-btn').addEventListener('click', () => {
            if (socket && socket.connected) {
                socket.emit('time_attack_respawn', {client_id: myId});
            }
        });
    }
    
    function drawTimeAttack() {
        console.log('[DEBUG] drawTimeAttack çağrıldı, timeAttackState:', timeAttackState);
        console.log('[DEBUG] Canvas boyutları:', canvas.width, 'x', canvas.height);
        console.log('[DEBUG] CELL_SIZE:', CELL_SIZE);
        
        if (!timeAttackState) {
            console.log('[DEBUG] timeAttackState yok, çıkıyor');
            return;
        }
        
        console.log('[DEBUG] drawTimeAttack: Time Attack modu çiziliyor');
        
        // Canvas'ı tamamen temizle
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        console.log('[DEBUG] drawTimeAttack: Canvas temizlendi');
        
        // Sadece Time Attack için arka plan
        if (assets.bg) {
            console.log('[DEBUG] drawTimeAttack: Arka plan çiziliyor');
            const pattern = ctx.createPattern(assets.bg, 'repeat');
            ctx.save();
            ctx.fillStyle = pattern;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.restore();
        } else {
            console.log('[DEBUG] drawTimeAttack: Arka plan asset yok, siyah arka plan');
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        // Yılan
        if (timeAttackState.snake) {
            console.log('[DEBUG] drawTimeAttack: Yılan çiziliyor, uzunluk:', timeAttackState.snake.length);
            ctx.fillStyle = 'lime';
            for (const [i, seg] of timeAttackState.snake.entries()) {
                const x = seg[0] * CELL_SIZE;
                const y = seg[1] * CELL_SIZE;
                ctx.fillRect(x, y, CELL_SIZE, CELL_SIZE);
                console.log('[DEBUG] drawTimeAttack: Yılan segmenti çizildi:', seg, 'pozisyon:', x, y);
            }
        } else {
            console.log('[DEBUG] drawTimeAttack: Yılan yok');
        }
        
        // Yemler
        if (timeAttackState.food) {
            console.log('[DEBUG] drawTimeAttack: Yemler çiziliyor, sayı:', timeAttackState.food.length);
            for (const food of timeAttackState.food) {
                if (assets.apple) {
                    ctx.drawImage(assets.apple, food[0]*CELL_SIZE, food[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    console.log('[DEBUG] drawTimeAttack: Elma asset ile çizildi:', food);
                } else {
                    ctx.fillStyle = 'red';
                    ctx.fillRect(food[0]*CELL_SIZE, food[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    console.log('[DEBUG] drawTimeAttack: Kırmızı kare ile yem çizildi:', food);
                }
            }
        } else {
            console.log('[DEBUG] drawTimeAttack: Yem yok');
        }
        
        // Altın elma
        if (timeAttackState.golden_food) {
            if (assets.golden) {
                ctx.drawImage(assets.golden, timeAttackState.golden_food[0]*CELL_SIZE, timeAttackState.golden_food[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
            } else {
                ctx.fillStyle = 'gold';
                ctx.fillRect(timeAttackState.golden_food[0]*CELL_SIZE, timeAttackState.golden_food[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
            }
        }
        
        // Engeller
        if (timeAttackState.obstacles) {
            for (const obs of timeAttackState.obstacles) {
                const [ox, oy] = obs.pos;
                const size = CELL_SIZE * 1.5;
                const offset = (size - CELL_SIZE) / 2;
                if ((obs.type === 'grass' || obs.type === 'slow') && assets.grass) {
                    ctx.drawImage(assets.grass, ox*CELL_SIZE - offset, oy*CELL_SIZE - offset, size, size);
                } else if (obs.type === 'poison' && assets.box) {
                    ctx.drawImage(assets.box, ox*CELL_SIZE - offset, oy*CELL_SIZE - offset, size, size);
                } else if (obs.type === 'hidden_wall') {
                    // Gizli duvarlar yılanın başının 4 blok yakınında görünür
                    let show = false;
                    if (timeAttackState.snake && timeAttackState.snake.length > 0) {
                        const [hx, hy] = timeAttackState.snake[0];
                        const dist = Math.abs(hx - ox) + Math.abs(hy - oy);
                        if (dist <= 4) show = true;
                    }
                    if (show) {
                        ctx.fillStyle = '#555';
                        ctx.fillRect(ox*CELL_SIZE, oy*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    }
                }
            }
        }
        
        // Portallar
        if (timeAttackState.portals) {
            for (const portal of timeAttackState.portals) {
                const [px1, py1] = portal[0];
                const [px2, py2] = portal[1];
                
                // Portal A
                ctx.fillStyle = 'rgba(255, 0, 255, 0.7)';
                ctx.beginPath();
                ctx.arc(px1*CELL_SIZE + CELL_SIZE/2, py1*CELL_SIZE + CELL_SIZE/2, CELL_SIZE/2, 0, 2*Math.PI);
                ctx.fill();
                ctx.strokeStyle = 'rgba(255, 0, 255, 1)';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Portal B
                ctx.fillStyle = 'rgba(0, 255, 255, 0.7)';
                ctx.beginPath();
                ctx.arc(px2*CELL_SIZE + CELL_SIZE/2, py2*CELL_SIZE + CELL_SIZE/2, CELL_SIZE/2, 0, 2*Math.PI);
                ctx.fill();
                ctx.strokeStyle = 'rgba(0, 255, 255, 1)';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
        }
        
        // Power-up'lar
        if (timeAttackState.powerups) {
            console.log('[DEBUG] drawTimeAttack: Power-up\'lar çiziliyor, sayı:', timeAttackState.powerups.length);
            for (const powerup of timeAttackState.powerups) {
                const [px, py] = powerup.pos;
                const powerupColors = {
                    'shield': '#000',      // Siyah
                    'speed': '#00f',       // Mavi
                    'reverse': '#fff',     // Beyaz
                    'magnet': '#800080'    // Mor
                };
                
                // Power-up yuvarlak arka planı
                ctx.beginPath();
                ctx.arc(px*CELL_SIZE + CELL_SIZE/2, py*CELL_SIZE + CELL_SIZE/2, CELL_SIZE/2 - 2, 0, 2*Math.PI);
                ctx.fillStyle = powerupColors[powerup.type] || '#00f';
                ctx.fill();
                
                // Power-up yuvarlak kenarlığı
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 2;
                ctx.stroke();
                
                // Power-up tipini yaz
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(powerup.type.charAt(0).toUpperCase(), 
                           px*CELL_SIZE + CELL_SIZE/2, 
                           py*CELL_SIZE + CELL_SIZE/2);
                
                // Yanıp sönen efekt - yuvarlak
                const time = Date.now() / 1000;
                const alpha = 0.5 + 0.5 * Math.sin(time * 3);
                ctx.globalAlpha = alpha;
                ctx.beginPath();
                ctx.arc(px*CELL_SIZE + CELL_SIZE/2, py*CELL_SIZE + CELL_SIZE/2, CELL_SIZE/3, 0, 2*Math.PI);
                ctx.fillStyle = '#fff';
                ctx.fill();
                ctx.globalAlpha = 1.0;
                
                console.log('[DEBUG] drawTimeAttack: Power-up çizildi:', powerup.type, 'pozisyon:', px, py);
            }
        } else {
            console.log('[DEBUG] drawTimeAttack: Power-up yok');
        }
        
        updateTimeAttackUI();
    }
    
    function updateTimeAttackUI() {
        if (!timeAttackState) return;
        
        const timeLeft = document.getElementById('time-left');
        const score = document.getElementById('score');
        const respawnCount = document.getElementById('respawn-count');
        const difficultyDisplay = document.getElementById('difficulty-display');
        
        if (timeLeft) timeLeft.textContent = `${Math.floor(timeAttackState.time_left)}s`;
        if (score) score.textContent = timeAttackState.score;
        if (respawnCount) respawnCount.textContent = timeAttackState.respawn_count;
        if (difficultyDisplay) {
            const difficultyNames = {
                'easy': 'Kolay',
                'medium': 'Orta',
                'hard': 'Zor'
            };
            difficultyDisplay.textContent = `Zorluk: ${difficultyNames[timeAttackState.difficulty] || '--'}`;
        }
        
        // Oyun durduysa canlanma mesajı göster
        if (!timeAttackState.game_active) {
            // Süre bittiyse sonuç göster
            if (timeAttackState.time_left <= 0) {
                showTimeAttackResult();
            } else {
                // Yılan elendi, canlanma mesajı göster
                showRespawnMessage();
            }
        }
    }
    
    function showRespawnMessage() {
        // Eğer zaten canlanma mesajı varsa gösterme
        if (document.getElementById('respawn-message')) return;
        
        const message = document.createElement('div');
        message.id = 'respawn-message';
        message.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.9);
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            z-index: 1000;
            font-size: 18px;
        `;
        
        message.innerHTML = `
            <h3>Yılan Elendi!</h3>
            <p>Canlanmak için <strong>ENTER</strong> tuşuna basın</p>
            <p>Kalan Süre: ${Math.floor(timeAttackState.time_left)}s</p>
        `;
        
        document.body.appendChild(message);
    }
    
    function hideRespawnMessage() {
        const message = document.getElementById('respawn-message');
        if (message) {
            message.remove();
        }
    }
    
    function showTimeAttackResult() {
        // Canlanma mesajını gizle
        hideRespawnMessage();
        
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        `;
        
        modal.innerHTML = `
            <div style="background: #333; padding: 30px; border-radius: 15px; text-align: center; color: #fff;">
                <h2>SÜRE BİTTİ!</h2>
                <p>Son Oyun Skoru: ${timeAttackState.score}</p>
                <p>En Yüksek Skor: ${timeAttackState.high_score}</p>
                <button id="play-again-btn" style="margin: 10px; padding: 10px 20px; background: #4caf50; border: none; border-radius: 5px; color: #fff; cursor: pointer;">Tekrar Oyna</button>
                <button id="back-to-menu-btn" style="margin: 10px; padding: 10px 20px; background: #666; border: none; border-radius: 5px; color: #fff; cursor: pointer;">Ana Menü</button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        document.getElementById('play-again-btn').addEventListener('click', () => {
            modal.remove();
            // Yeni Time Attack oyunu başlat
            if (socket && socket.connected) {
                socket.emit('start_time_attack', {client_id: myId, difficulty: currentDifficulty});
            }
        });
        
        document.getElementById('back-to-menu-btn').addEventListener('click', () => {
            modal.remove();
            // Ana menüye dön
            document.getElementById('ui').style.display = 'flex';
            document.getElementById('game-container').style.display = 'none';
            document.getElementById('top-usernames').style.display = 'none';
            const timeAttackUI = document.getElementById('time-attack-ui');
            if (timeAttackUI) timeAttackUI.remove();
            currentGameMode = null;
            currentDifficulty = null;
            timeAttackState = null;
        });
    }
    
    function sendTimeAttackMove(direction) {
        if (socket && socket.connected) {
            socket.emit('time_attack_move', {client_id: myId, direction: direction});
        }
    }
    
    // Capture the Flag fonksiyonları
    function showCTFUI() {
        const existingUI = document.getElementById('ctf-ui');
        if (existingUI) {
            existingUI.remove();
        }
        
        const ui = document.createElement('div');
        ui.id = 'ctf-ui';
        ui.innerHTML = `
            <h3>Capture the Flag</h3>
            <div id="ctf-time-display">Süre: <span id="ctf-time-left">300</span></div>
            <div id="ctf-team-display">Takım: <span id="ctf-team">--</span></div>
            <div id="ctf-player-score-display">Kişisel Skor: <span id="ctf-player-score">0</span></div>
            <div id="ctf-waiting-display" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); color: #fff; padding: 30px; border-radius: 15px; font-size: 32px; font-weight: bold; display: none; z-index: 1000; border: 3px solid #e74c3c; box-shadow: 0 0 20px rgba(231, 76, 60, 0.5);">Bekleme Süresi: <span id="ctf-waiting-time">0</span>s</div>
            <div id="ctf-red-score-display" style="position: absolute; bottom: 10px; left: 10px; color: #e74c3c; font-weight: bold;">Kırmızı: <span id="ctf-red-score">0</span></div>
            <div id="ctf-blue-score-display" style="position: absolute; bottom: 10px; right: 10px; color: #3498db; font-weight: bold;">Mavi: <span id="ctf-blue-score">0</span></div>
            <button id="ctf-respawn-btn" style="display:none;">Canlan (5s)</button>
        `;
        document.body.appendChild(ui);
        
        // Respawn butonu event listener
        document.getElementById('ctf-respawn-btn').addEventListener('click', () => {
            if (socket && socket.connected) {
                socket.emit('ctf_respawn', {client_id: myId});
            }
        });
    }
    
    function drawCTF() {
        if (!ctfGameState) {
            console.log('[DEBUG] drawCTF: ctfGameState yok');
            return;
        }
        
        console.log('[DEBUG] drawCTF: CTF modu çiziliyor');
        
        // Canvas'ı tamamen temizle
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Sadece CTF için gri arka plan
        ctx.fillStyle = '#808080'; // Düz gri
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Beyaz çerçeve çiz
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.strokeRect(0, 0, canvas.width, canvas.height);
        
        // Ortadaki beyaz çizgi (takım alanlarını ayıran)
        const centerX = canvas.width / 2;
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(centerX, 0);
        ctx.lineTo(centerX, canvas.height);
        ctx.stroke();
        
        // Bayrak alanlarını çiz
        const cellSize = CELL_SIZE;
        
        // Kırmızı bayrak alanı (sol duvarın ortası)
        ctx.fillStyle = 'rgba(231, 76, 60, 0.3)'; // Şeffaf kırmızı
        ctx.fillRect(1 * cellSize, 15 * cellSize, 4 * cellSize, 5 * cellSize);
        
        // Mavi bayrak alanı (sağ duvarın ortası)
        ctx.fillStyle = 'rgba(52, 152, 219, 0.3)'; // Şeffaf mavi
        ctx.fillRect(55 * cellSize, 15 * cellSize, 4 * cellSize, 5 * cellSize);
        
        // Yılanları çiz
        if (ctfGameState.snakes) {
            console.log('[DEBUG] drawCTF: Yılanlar çiziliyor, sayı:', Object.keys(ctfGameState.snakes).length);
            for (const [pid, snake] of Object.entries(ctfGameState.snakes)) {
                // Sadece aktif oyuncuların yılanlarını çiz
                if (ctfGameState.active && ctfGameState.active[pid]) {
                    const playerTeam = ctfGameState.teams?.red?.includes(pid) ? 'red' : 
                                     ctfGameState.teams?.blue?.includes(pid) ? 'blue' : null;
                    
                    // Takım rengini belirle
                    let color = '#2ecc71'; // Varsayılan yeşil
                    if (playerTeam === 'red') {
                        color = '#e74c3c'; // Kırmızı takım
                    } else if (playerTeam === 'blue') {
                        color = '#3498db'; // Mavi takım
                    }
                    
                    ctx.fillStyle = color;
                    for (const seg of snake) {
                        ctx.fillRect(seg[0]*CELL_SIZE, seg[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    }
                }
            }
        } else {
            console.log('[DEBUG] drawCTF: Yılan yok');
        }
        
        // Bayrakları çiz
        if (ctfGameState.flags) {
            console.log('[DEBUG] drawCTF: Bayraklar çiziliyor');
            
            // Kırmızı bayrak
            if (ctfGameState.flags.red) {
                const flag = ctfGameState.flags.red;
                if (!flag.captured) {
                    // Bayrak pozisyonunda kırmızı bayrak çiz
                    ctx.fillStyle = '#e74c3c';
                    ctx.fillRect(flag.pos[0]*CELL_SIZE, flag.pos[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    
                    // Bayrak işareti çiz
                    ctx.fillStyle = '#fff';
                    ctx.fillRect((flag.pos[0]+0.2)*CELL_SIZE, (flag.pos[1]+0.2)*CELL_SIZE, CELL_SIZE*0.6, CELL_SIZE*0.6);
                }
            }
            
            // Mavi bayrak
            if (ctfGameState.flags.blue) {
                const flag = ctfGameState.flags.blue;
                if (!flag.captured) {
                    // Bayrak pozisyonunda mavi bayrak çiz
                    ctx.fillStyle = '#3498db';
                    ctx.fillRect(flag.pos[0]*CELL_SIZE, flag.pos[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    
                    // Bayrak işareti çiz
                    ctx.fillStyle = '#fff';
                    ctx.fillRect((flag.pos[0]+0.2)*CELL_SIZE, (flag.pos[1]+0.2)*CELL_SIZE, CELL_SIZE*0.6, CELL_SIZE*0.6);
                }
            }
            
            // Bayrak taşıyan oyuncuları işaretle
            for (const [pid, snake] of Object.entries(ctfGameState.snakes)) {
                if (ctfGameState.active && ctfGameState.active[pid]) {
                    const head = snake[0];
                    
                    // Kırmızı bayrak taşıyor mu?
                    if (ctfGameState.flags.red && ctfGameState.flags.red.captured && 
                        ctfGameState.flags.red.carrier === pid) {
                        // Kırmızı bayrak taşıyan oyuncuya parıltı efekti
                        const glowRadius = 8;
                        
                        // Parıltı efekti için gradient
                        const gradient = ctx.createRadialGradient(
                            head[0]*CELL_SIZE + CELL_SIZE/2, head[1]*CELL_SIZE + CELL_SIZE/2, 0,
                            head[0]*CELL_SIZE + CELL_SIZE/2, head[1]*CELL_SIZE + CELL_SIZE/2, glowRadius
                        );
                        gradient.addColorStop(0, 'rgba(231, 76, 60, 0.8)');
                        gradient.addColorStop(0.5, 'rgba(231, 76, 60, 0.4)');
                        gradient.addColorStop(1, 'rgba(231, 76, 60, 0)');
                        
                        ctx.fillStyle = gradient;
                        ctx.fillRect(
                            head[0]*CELL_SIZE - glowRadius, 
                            head[1]*CELL_SIZE - glowRadius, 
                            CELL_SIZE + glowRadius*2, 
                            CELL_SIZE + glowRadius*2
                        );
                        
                        // Yılanın kendisini daha parlak çiz
                        ctx.fillStyle = '#ff6b6b';
                        ctx.fillRect(head[0]*CELL_SIZE, head[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    }
                    
                    // Mavi bayrak taşıyor mu?
                    if (ctfGameState.flags.blue && ctfGameState.flags.blue.captured && 
                        ctfGameState.flags.blue.carrier === pid) {
                        // Mavi bayrak taşıyan oyuncuya parıltı efekti
                        const glowRadius = 8;
                        
                        // Parıltı efekti için gradient
                        const gradient = ctx.createRadialGradient(
                            head[0]*CELL_SIZE + CELL_SIZE/2, head[1]*CELL_SIZE + CELL_SIZE/2, 0,
                            head[0]*CELL_SIZE + CELL_SIZE/2, head[1]*CELL_SIZE + CELL_SIZE/2, glowRadius
                        );
                        gradient.addColorStop(0, 'rgba(52, 152, 219, 0.8)');
                        gradient.addColorStop(0.5, 'rgba(52, 152, 219, 0.4)');
                        gradient.addColorStop(1, 'rgba(52, 152, 219, 0)');
                        
                        ctx.fillStyle = gradient;
                        ctx.fillRect(
                            head[0]*CELL_SIZE - glowRadius, 
                            head[1]*CELL_SIZE - glowRadius, 
                            CELL_SIZE + glowRadius*2, 
                            CELL_SIZE + glowRadius*2
                        );
                        
                        // Yılanın kendisini daha parlak çiz
                        ctx.fillStyle = '#74b9ff';
                        ctx.fillRect(head[0]*CELL_SIZE, head[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    }
                }
            }
        } else {
            console.log('[DEBUG] drawCTF: Bayrak yok');
        }
        
        // UI güncelle
        updateCTFUI();
    }
    
    function updateCTFUI() {
        if (!ctfGameState) return;
        
        const timeLeft = document.getElementById('ctf-time-left');
        const teamDisplay = document.getElementById('ctf-team');
        const playerScore = document.getElementById('ctf-player-score');
        const redScore = document.getElementById('ctf-red-score');
        const blueScore = document.getElementById('ctf-blue-score');
        const respawnBtn = document.getElementById('ctf-respawn-btn');
        const waitingDisplay = document.getElementById('ctf-waiting-display');
        const waitingTime = document.getElementById('ctf-waiting-time');
        
        if (timeLeft && ctfGameState.game_time !== undefined) {
            timeLeft.textContent = Math.floor(ctfGameState.game_time);
        }
        
        if (teamDisplay && ctfTeam) {
            teamDisplay.textContent = ctfTeam === 'red' ? 'Kırmızı' : 'Mavi';
        }
        
        // Takım skorlarını güncelle
        if (redScore && ctfGameState.team_scores) {
            redScore.textContent = ctfGameState.team_scores.red || 0;
        }
        
        if (blueScore && ctfGameState.team_scores) {
            blueScore.textContent = ctfGameState.team_scores.blue || 0;
        }
        
        if (playerScore && ctfGameState.individual_scores && myId) {
            playerScore.textContent = ctfGameState.individual_scores[myId] || 0;
        }
        
        // Bekleme süresi göstergesini kontrol et
        if (waitingDisplay && waitingTime && myId) {
            console.log('[DEBUG] Bekleme süresi kontrolü:', {
                myId: myId,
                active: ctfGameState.active,
                myActive: ctfGameState.active[myId],
                respawnTimers: ctfGameState.respawn_timers,
                myRespawnTimer: ctfGameState.respawn_timers?.[myId]
            });
            
            if (ctfGameState.active && !ctfGameState.active[myId]) {
                console.log('[DEBUG] Oyuncu aktif değil, bekleme süresi kontrol ediliyor');
                // Oyuncu aktif değilse bekleme süresini göster
                if (ctfGameState.respawn_timers && ctfGameState.respawn_timers[myId]) {
                    const currentTime = Date.now() / 1000;
                    const respawnTime = ctfGameState.respawn_timers[myId];
                    const remainingTime = respawnTime - currentTime;
                    
                    console.log('[DEBUG] Respawn timer hesaplaması:', {
                        currentTime: currentTime,
                        respawnTime: respawnTime,
                        remainingTime: remainingTime
                    });
                    
                    if (remainingTime > 0) {
                        console.log('[DEBUG] Bekleme süresi gösteriliyor:', remainingTime.toFixed(1));
                        waitingDisplay.style.display = 'block';
                        waitingTime.textContent = remainingTime.toFixed(1);
                    } else {
                        console.log('[DEBUG] Bekleme süresi gizleniyor (süre doldu)');
                        waitingDisplay.style.display = 'none';
                    }
                } else {
                    console.log('[DEBUG] Respawn timer yok, bekleme süresi gizleniyor');
                    waitingDisplay.style.display = 'none';
                }
            } else {
                console.log('[DEBUG] Oyuncu aktif, bekleme süresi gizleniyor');
                waitingDisplay.style.display = 'none';
            }
        } else {
            console.log('[DEBUG] Bekleme süresi elementi bulunamadı:', {
                waitingDisplay: !!waitingDisplay,
                waitingTime: !!waitingTime,
                myId: myId
            });
        }
        
        // Respawn butonunu kontrol et
        if (respawnBtn && myId) {
            // Oyuncu aktif değilse respawn butonunu göster
            if (ctfGameState.active && !ctfGameState.active[myId]) {
                respawnBtn.style.display = 'inline-block';
                
                // Kalan süreyi hesapla
                if (ctfGameState.respawn_timers && ctfGameState.respawn_timers[myId]) {
                    const currentTime = Date.now() / 1000; // JavaScript timestamp'i saniyeye çevir
                    const respawnTime = ctfGameState.respawn_timers[myId];
                    const remainingTime = respawnTime - currentTime;
                    
                    if (remainingTime > 0) {
                        respawnBtn.textContent = `Canlan (${remainingTime.toFixed(1)}s)`;
                    } else {
                        respawnBtn.textContent = 'Canlan (Enter)';
                    }
                } else {
                    respawnBtn.textContent = 'Canlan (Enter)';
                }
            } else {
                respawnBtn.style.display = 'none';
            }
        }
    }
    
    // CTF UI'ı daha sık güncelle (respawn countdown için)
    function startCTFUITimer() {
        if (currentGameMode === 'captureTheFlag') {
            setInterval(() => {
                if (ctfGameState) {
                    updateCTFUI();
                }
            }, 100); // 100ms'de bir güncelle (10 FPS)
        }
    }
    
    function showCTFResult(data) {
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        `;
        
        const winner = data.winner || 'tie';
        const winnerText = winner === 'red' ? 'Kırmızı Takım' : 
                          winner === 'blue' ? 'Mavi Takım' : 'Beraberlik';
        
        modal.innerHTML = `
            <div style="background: #333; padding: 30px; border-radius: 15px; text-align: center; color: #fff;">
                <h2>OYUN BİTTİ!</h2>
                <p>Kazanan: ${winnerText}</p>
                <p>Kırmızı Takım Skoru: ${data.team_scores?.red || 0}</p>
                <p>Mavi Takım Skoru: ${data.team_scores?.blue || 0}</p>
                <button id="ctf-play-again-btn" style="margin: 10px; padding: 10px 20px; background: #4caf50; border: none; border-radius: 5px; color: #fff; cursor: pointer;">Tekrar Oyna</button>
                <button id="ctf-back-to-menu-btn" style="margin: 10px; padding: 10px 20px; background: #666; border: none; border-radius: 5px; color: #fff; cursor: pointer;">Ana Menü</button>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Buton event listener'larını ekle
        const playAgainBtn = document.getElementById('ctf-play-again-btn');
        const backToMenuBtn = document.getElementById('ctf-back-to-menu-btn');
        
        if (playAgainBtn) {
            playAgainBtn.addEventListener('click', () => {
                console.log('[DEBUG] Tekrar Oyna butonuna tıklandı');
                modal.remove();
                // Oyun modu seçme ekranına dön
                document.getElementById('ui').style.display = 'flex';
                document.getElementById('game-container').style.display = 'none';
                document.getElementById('top-usernames').style.display = 'none';
                const ctfUI = document.getElementById('ctf-ui');
                if (ctfUI) ctfUI.remove();
                currentGameMode = null;
                ctfGameState = null;
                ctfTeam = null;
            });
        } else {
            console.error('[DEBUG] Tekrar Oyna butonu bulunamadı!');
        }
        
        if (backToMenuBtn) {
            backToMenuBtn.addEventListener('click', () => {
                console.log('[DEBUG] Ana Menü butonuna tıklandı');
                modal.remove();
                // Ana menüye dön
                document.getElementById('ui').style.display = 'flex';
                document.getElementById('game-container').style.display = 'none';
                document.getElementById('top-usernames').style.display = 'none';
                const ctfUI = document.getElementById('ctf-ui');
                if (ctfUI) ctfUI.remove();
                currentGameMode = null;
                ctfGameState = null;
                ctfTeam = null;
            });
        } else {
            console.error('[DEBUG] Ana Menü butonu bulunamadı!');
        }
    }
    
    function sendCTFMove(direction) {
        if (socket && socket.connected) {
            socket.emit('ctf_move', {client_id: myId, direction: direction});
        }
    }
    
    // Oyun state güncellendiğinde restart butonunu göster/gizle
    function updateRestartButton() {
        const restart = document.getElementById('btn-restart');
        if (!restart) return;
        if (myId && gameState && gameState.active && !gameState.active[myId]) {
            restart.style.display = 'inline-flex';
        } else if (gameState && gameState.waiting_for_restart) {
            restart.style.display = 'inline-flex';
        } else {
            restart.style.display = 'none';
        }
    }

    // --- Başlat ---
    loadAssets(() => {
        resizeGameCanvas();
        draw();
    });

    // --- Tam ekran fonksiyonu ---
    // (Kaldırıldı)

    // Test fonksiyonu - bekleme süresini manuel olarak göster
    function testWaitingDisplay() {
        console.log('[DEBUG] Test: Bekleme süresi test ediliyor');
        const waitingDisplay = document.getElementById('ctf-waiting-display');
        const waitingTime = document.getElementById('ctf-waiting-time');
        
        if (waitingDisplay && waitingTime) {
            console.log('[DEBUG] Test: Elementler bulundu, gösteriliyor');
            waitingDisplay.style.display = 'block';
            waitingTime.textContent = '5.0';
        } else {
            console.error('[DEBUG] Test: Elementler bulunamadı!');
        }
    }
    
    // Test için global fonksiyon
    window.testWaitingDisplay = testWaitingDisplay;
    </script>
</body>
</html>
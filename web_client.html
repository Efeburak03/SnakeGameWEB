<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>WebSocket Snake Game</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: #222;
        }
        #ui {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: fixed;
            inset: 0;
            z-index: 10;
            /* Arka planı bulanık ve görsel ile kapla */
            background: url('assets/Background.jpg') center center/cover no-repeat;
        }
        #ui::before {
            content: '';
            position: absolute;
            inset: 0;
            background: rgba(34,34,34,0.55);
            backdrop-filter: blur(6px);
            z-index: -1;
        }
        #ui h1 {
            margin-bottom: 32px;
            font-size: 2.8em;
            font-weight: 900;
            letter-spacing: 2px;
            color: #fff;
            text-shadow: 0 2px 12px #000a;
        }
        #ui input {
            margin-bottom: 12px;
            padding: 12px 24px;
            font-size: 1.3em;
            border-radius: 10px;
            border: 2px solid #444;
            outline: none;
            background: rgba(255,255,255,0.12);
            color: #fff;
            font-family: 'Segoe UI', Arial, sans-serif;
            box-shadow: 0 2px 8px rgba(0,0,0,0.10);
            transition: border 0.2s, box-shadow 0.2s;
        }
        #ui input:focus {
            border: 2px solid #4caf50;
            box-shadow: 0 2px 12px #4caf5055;
        }
        #ui input.error {
            border: 2px solid #e53935;
        }
        #ui button {
            margin-bottom: 8px;
            padding: 12px 32px;
            font-size: 1.2em;
            border-radius: 10px;
            border: none;
            background: linear-gradient(90deg, #4caf50 60%, #388e3c 100%);
            color: #fff;
            font-weight: bold;
            letter-spacing: 1px;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.13);
            transition: background 0.2s, box-shadow 0.2s;
        }
        #ui button:hover, #ui button:focus {
            background: linear-gradient(90deg, #388e3c 60%, #4caf50 100%);
            box-shadow: 0 4px 16px #4caf5055;
        }
        #ui .error-msg {
            color: #e53935;
            font-size: 1.1em;
            margin-bottom: 10px;
            min-height: 24px;
            font-weight: 500;
            text-shadow: 0 1px 4px #000a;
        }
        #game-container {
            margin-left: 0;
        }
        #game {
            background: #111;
            display: block;
            margin: 0 auto;
            border-radius: 12px;
            box-shadow: 0 2px 16px rgba(0,0,0,0.25);
        }
        .game-message {
            position: absolute;
            left: 0; right: 0; top: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
            z-index: 5;
        }
        .game-message span {
            background: rgba(34,34,34,0.85);
            color: #fff;
            font-size: 2.5em;
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 24px 48px;
            border-radius: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.18);
        }
        #top-usernames {
            position: fixed;
            left: 160px;
            top: 0;
            width: calc(100vw - 160px);
            height: 48px;
            background: transparent;
            color: #fff;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start;
            z-index: 15;
            font-size: 1.3em;
            font-family: 'Segoe UI', Arial, sans-serif;
            padding-left: 32px;
            gap: 48px;
            pointer-events: none;
        }
        #top-usernames span {
            background: rgba(34,34,34,0.45);
            border-radius: 8px;
            padding: 6px 18px;
            margin-right: 0;
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <div id="ui">
        <h1>Snake Game</h1>
        <div class="error-msg" id="ui-error"></div>
        <input id="nicknameInput" type="text" maxlength="16" placeholder="Kullanıcı adı" />
        <button id="startBtn">Başla</button>
    </div>
    <div id="top-usernames" style="display:none;"></div>
    <div id="game-container" style="display:none;">
        <div style="position:relative;">
            <canvas id="game" width="1200" height="700"></canvas>
            <div id="game-message" class="game-message" style="display:none;"><span></span></div>
        </div>
    </div>
    <script>
    // --- Oyun parametreleri ---
    let BOARD_WIDTH = 60;
    let BOARD_HEIGHT = 35  ;
    let CELL_SIZE = 20;
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    let ws = null;
    let myId = null;
    let gameState = null;
    let started = false;
    let readySent = false;
    let eliminationTime = null;
    let currentDirection = null; // Başlangıçta null
    let nickname = '';
    let assets = {};

    // --- Görselleri yükle ---
    const assetFiles = {
        apple: 'assets/elma.png',
        golden: 'assets/golden_apple.png',
        grass: 'assets/çimen.png',
        box: 'assets/kutu.png',
        portal: 'assets/portal.png',
        bg: 'assets/Background.jpg',
        eagle: 'assets/eagle_500kg.png', // EAGLE PNG EKLENDİ
    };
    function loadAssets(cb) {
        let loaded = 0, total = Object.keys(assetFiles).length;
        for (const [key, src] of Object.entries(assetFiles)) {
            const img = new Image();
            img.onload = () => { assets[key] = img; if (++loaded === total) cb(); };
            img.onerror = () => { loaded++; if (loaded === total) cb(); };
            img.src = src;
        }
    }

    // --- WebSocket bağlantısı ---
    function connect() {
        ws = new WebSocket('wss://snakegameweb.onrender.com');
        ws.onopen = () => {
            ws.send(JSON.stringify({type: 'join', client_id: nickname}));
        };
        ws.onmessage = (event) => {
            const state = JSON.parse(event.data);
            gameState = state;
            if (!myId) myId = nickname;
            draw();
            updateTopUsernames();
            // Eagle overlay'i burada asla kapatma!
        };
        ws.onclose = () => {
            setTimeout(connect, 1000);
        };
    }

    // --- Oyun çizimi ---
    function draw() {
        // Arka planı tekrar eden desen olarak döşe
        if (assets.bg) {
            const pattern = ctx.createPattern(assets.bg, 'repeat');
            ctx.save();
            ctx.fillStyle = pattern;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.restore();
        } else if (assets.grass) {
            const pattern = ctx.createPattern(assets.grass, 'repeat');
            ctx.save();
            ctx.fillStyle = pattern;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.restore();
        } else {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
        if (!gameState) return;
        // Yılanlar
        if (gameState.snakes) {
            for (const [pid, snake] of Object.entries(gameState.snakes)) {
                let frozen = false;
                if (gameState.powerup_timers && gameState.powerup_timers[pid] && gameState.powerup_timers[pid]["frozen"] > 0) frozen = true;
                ctx.fillStyle = frozen ? '#888' : (pid === myId ? 'lime' : 'yellow');
                for (const [i, seg] of snake.entries()) {
                    ctx.fillRect(seg[0]*CELL_SIZE, seg[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                }
            }
        }
        // Engeller (yılanlardan sonra çiz)
        if (gameState.obstacles) {
            for (const obs of gameState.obstacles) {
                const [ox, oy] = obs.pos;
                const size = CELL_SIZE * 1.5;
                const offset = (size - CELL_SIZE) / 2;
                if (obs.type === 'slow' && assets.grass) ctx.drawImage(assets.grass, ox*CELL_SIZE - offset, oy*CELL_SIZE - offset, size, size);
                else if (obs.type === 'poison' && assets.box) ctx.drawImage(assets.box, ox*CELL_SIZE - offset, oy*CELL_SIZE - offset, size, size);
                else if (obs.type === 'hidden_wall') {
                    let show = false;
                    if (gameState.snakes && myId && gameState.snakes[myId] && gameState.snakes[myId].length > 0) {
                        const [hx, hy] = gameState.snakes[myId][0];
                        const dist = Math.abs(hx - ox) + Math.abs(hy - oy);
                        if (dist <= 4) show = true;
                    }
                    if (show) {
                    ctx.fillStyle = '#555';
                    ctx.fillRect(ox*CELL_SIZE, oy*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    }
                }
            }
        }
        // Portallar
        if (gameState.portals) {
            for (const [a, b] of gameState.portals) {
                if (assets.portal) {
                    const size = CELL_SIZE * 1.2;
                    const offset = (size - CELL_SIZE) / 2;
                    ctx.drawImage(assets.portal, a[0]*CELL_SIZE - offset, a[1]*CELL_SIZE - offset, size, size);
                    ctx.drawImage(assets.portal, b[0]*CELL_SIZE - offset, b[1]*CELL_SIZE - offset, size, size);
                } else {
                    ctx.fillStyle = '#80f';
                    ctx.fillRect(a[0]*CELL_SIZE, a[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                    ctx.fillRect(b[0]*CELL_SIZE, b[1]*CELL_SIZE, CELL_SIZE, CELL_SIZE);
                }
            }
        }
        // Yemler
        if (gameState.food) {
            for (const [fx, fy] of gameState.food) {
                if (assets.apple) {
                    const size = CELL_SIZE * 1.2;
                    const offset = (size - CELL_SIZE) / 2;
                    ctx.drawImage(assets.apple, fx*CELL_SIZE - offset, fy*CELL_SIZE - offset, size, size);
                } else { ctx.fillStyle = 'red'; ctx.fillRect(fx*CELL_SIZE, fy*CELL_SIZE, CELL_SIZE, CELL_SIZE); }
            }
        }
        // Altın elma
        if (gameState.golden_food) {
            const [gx, gy] = gameState.golden_food;
            if (assets.golden) ctx.drawImage(assets.golden, gx*CELL_SIZE, gy*CELL_SIZE, CELL_SIZE, CELL_SIZE);
            else { ctx.fillStyle = 'gold'; ctx.beginPath(); ctx.arc(gx*CELL_SIZE+CELL_SIZE/2, gy*CELL_SIZE+CELL_SIZE/2, CELL_SIZE/2, 0, 2*Math.PI); ctx.fill(); }
        }
        // Kalan süre
        if (gameState.time_left !== undefined) {
            ctx.fillStyle = 'yellow';
            ctx.font = '24px Arial';
            ctx.fillText('Süre: ' + (gameState.time_left||0) + ' sn', canvas.width/2-60, 30);
        }
        // Oyun mesajı gösterimi
        const msgDiv = document.getElementById('game-message');
        if (gameState.active && myId && !gameState.active[myId]) {
            msgDiv.style.display = 'flex';
            msgDiv.querySelector('span').textContent = 'Elenedin! Devam için Enter';
        } else if (gameState.waiting_for_restart) {
            msgDiv.style.display = 'flex';
            let winnerName = gameState.winner_id;
            let winnerScore = gameState.scores && winnerName ? gameState.scores[winnerName] : '';
            if (!winnerName || winnerName === '-') winnerName = 'Yok';
            msgDiv.querySelector('span').textContent =
                'Oyun Bitti! Kazanan: ' + winnerName + (winnerScore !== '' ? ' (' + winnerScore + ' puan)' : '') + '\n' +
                'Devam için Enter (tüm oyuncular)';
        } else {
            msgDiv.style.display = 'none';
        }
        // Power-up'lar
        if (gameState.powerups) {
            for (const pu of gameState.powerups) {
                const [x, y] = pu.pos;
                let color = '#ccc';
                if (pu.type === 'speed') color = 'blue';
                else if (pu.type === 'shield') color = 'black';
                else if (pu.type === 'invisible') color = 'gray';
                else if (pu.type === 'reverse') color = 'white';
                else if (pu.type === 'freeze') color = '#00c8ff';
                else if (pu.type === 'giant') color = 'orange';
                else if (pu.type === 'magnet') color = 'purple';
                ctx.beginPath();
                ctx.arc(x*CELL_SIZE+CELL_SIZE/2, y*CELL_SIZE+CELL_SIZE/2, CELL_SIZE/2.2, 0, 2*Math.PI);
                ctx.fillStyle = color;
                ctx.fill();
            }
        }
    }

    // --- Skor tablosu ---
    function updateScoreboard() { /* Artık kullanılmıyor */ }

    function updateTopUsernames() {
        const topDiv = document.getElementById('top-usernames');
        if (!gameState || !gameState.scores) { topDiv.innerHTML = ''; return; }
        let html = '';
        for (const pid of Object.keys(gameState.scores)) {
            html += `<span>${pid}: ${gameState.scores[pid]}</span>`;
        }
        topDiv.innerHTML = html;
    }

    // --- Dinamik boyutlandırma fonksiyonu ---
    // (Tam ekran ve responsive kodları kaldırıldı)
    function resizeGameCanvas() {
        // Sabit boyut, sadece yeniden çiz
        draw();
    }
    // --- Tam ekran butonu kaldırıldı ---
    // window.addEventListener('resize', resizeGameCanvas);
    // --- Oyun başlatıldığında canvas'ı tam ekran boyutla ---
    document.getElementById('startBtn').onclick = startGame;
    document.getElementById('nicknameInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') startGame();
    });
    function startGame() {
        // Kullanıcı adını input'tan tekrar al
        const input = document.getElementById('nicknameInput');
        nickname = input.value.trim();
        // Matrix mode kontrolü
        if (nickname && ['matrix','neo','admin'].includes(nickname.toLowerCase())) {
            startMatrixRain();
        } else {
            stopMatrixRain();
        }
        const errorDiv = document.getElementById('ui-error');
        input.classList.remove('error');
        errorDiv.textContent = '';
        if (!nickname) {
            errorDiv.textContent = 'Kullanıcı adı gir!';
            input.classList.add('error');
            return;
        }
        if (nickname.length > 8) {
            errorDiv.textContent = 'Kullanıcı adı en fazla 8 karakter olmalı!';
            input.classList.add('error');
            return;
        }
        document.getElementById('ui').style.display = 'none';
        document.getElementById('game-container').style.display = 'flex';
        document.getElementById('top-usernames').style.display = 'flex';
        started = true;
        currentDirection = null;
        connect();
        draw();
    }

    // Easter egg: yukarı, sağ, aşağı, aşağı, aşağı kombinasyonu
    const easterEggSequence = ['ArrowUp', 'ArrowRight', 'ArrowDown', 'ArrowDown', 'ArrowDown'];
    let easterEggProgress = 0;
    document.addEventListener('keydown', (e) => {
        if (!started || !ws || ws.readyState !== 1) return;
        if (!myId) return;
        if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
            e.preventDefault();
        }
        if (e.key === 'ArrowUp') sendMove('UP');
        else if (e.key === 'ArrowDown') sendMove('DOWN');
        else if (e.key === 'ArrowLeft') sendMove('LEFT');
        else if (e.key === 'ArrowRight') sendMove('RIGHT');
        else if (e.key === 'Enter') {
            hideEagleEggScreen();
            if (gameState && gameState.active && !gameState.active[myId]) {
                ws.send(JSON.stringify({type: 'restart', client_id: myId}));
            } else if (gameState && gameState.waiting_for_restart) {
                if (!readySent) {
                    ws.send(JSON.stringify({type: 'ready', client_id: myId}));
                    readySent = true;
                }
            }
        }
        if (e.key === easterEggSequence[easterEggProgress]) {
            easterEggProgress++;
            if (easterEggProgress === easterEggSequence.length) {
                // PNG'yi hemen ekrana getir
                showEagleEggScreen();
                // Sunucuya özel mesaj gönder
                if (ws && ws.readyState === 1) {
                    ws.send(JSON.stringify({type: 'easteregg', client_id: myId}));
                }
                easterEggProgress = 0;
            }
        } else {
            easterEggProgress = 0;
        }
    });

    function sendMove(dir) {
        if (!myId) return;
        if (currentDirection && dir === currentDirection) return;
        ws.send(JSON.stringify({type: 'move', client_id: myId, direction: dir}));
        currentDirection = dir;
    }

    // Eagle easter egg görseli için asset yükle
    assets.eagle = new Image();
    assets.eagle.src = 'assets/eagle_500kg.png';

    function showEagleEggScreen() {
        let overlay = document.getElementById('eagle-egg-overlay');
        if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'eagle-egg-overlay';
            overlay.style.position = 'fixed';
            overlay.style.left = '0';
            overlay.style.top = '0';
            overlay.style.width = '100vw';
            overlay.style.height = '100vh';
            overlay.style.background = 'rgba(0,0,0,0.7)';
            overlay.style.display = 'flex';
            overlay.style.flexDirection = 'column';
            overlay.style.alignItems = 'center';
            overlay.style.justifyContent = 'center';
            overlay.style.zIndex = '9999';
            document.body.appendChild(overlay);
        }
        overlay.innerHTML = '';
        const img = document.createElement('img');
        img.src = assets.eagle.src;
        img.style.width = '220px';
        overlay.appendChild(img);
        overlay.style.display = 'flex';
    }

    // Oyuncu yeniden başlatınca eagle overlay'i kapat
    function hideEagleEggScreen() {
        const overlay = document.getElementById('eagle-egg-overlay');
        if (overlay) overlay.style.display = 'none';
    }

    // Matrix yağmuru için canvas'ı body'nin en başına ekle
    let matrixCanvas = document.getElementById('matrix-bg');
    if (!matrixCanvas) {
        matrixCanvas = document.createElement('canvas');
        matrixCanvas.id = 'matrix-bg';
        matrixCanvas.style.position = 'fixed';
        matrixCanvas.style.left = '0';
        matrixCanvas.style.top = '0';
        matrixCanvas.style.width = '100vw';
        matrixCanvas.style.height = '100vh';
        matrixCanvas.style.pointerEvents = 'none';
        matrixCanvas.style.zIndex = '0'; // EN ARKADA!
        document.body.insertBefore(matrixCanvas, document.body.firstChild);
    }
    // Oyun canvası ve UI elementlerinin z-index'i 1 veya daha yüksek olmalı
    const gameCanvas = document.getElementById('game');
    if (gameCanvas) gameCanvas.style.zIndex = '1';
    const topUsernames = document.getElementById('top-usernames');
    if (topUsernames) topUsernames.style.zIndex = '2';
    const gameContainer = document.getElementById('game-container');
    if (gameContainer) gameContainer.style.zIndex = '2';

    let matrixAnimId = null;
    function startMatrixRain() {
        const c = matrixCanvas;
        const ctx = c.getContext('2d');
        c.width = window.innerWidth;
        c.height = window.innerHeight;
        const letters = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズヅブプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッンABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        const fontSize = 18;
        const columns = Math.floor(c.width / fontSize);
        const drops = Array(columns).fill(1);
        function drawMatrix() {
            ctx.fillStyle = 'rgba(0,0,0,0.15)';
            ctx.fillRect(0, 0, c.width, c.height);
            ctx.font = fontSize + 'px monospace';
            ctx.fillStyle = '#0F0';
            for (let i = 0; i < drops.length; i++) {
                const text = letters[Math.floor(Math.random() * letters.length)];
                ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                if (drops[i] * fontSize > c.height && Math.random() > 0.975) {
                    drops[i] = 0;
                }
                drops[i]++;
            }
            matrixAnimId = requestAnimationFrame(drawMatrix);
        }
        drawMatrix();
        window.addEventListener('resize', resizeMatrixCanvas);
        function resizeMatrixCanvas() {
            c.width = window.innerWidth;
            c.height = window.innerHeight;
        }
    }
    function stopMatrixRain() {
        if (matrixAnimId) cancelAnimationFrame(matrixAnimId);
        const ctx = matrixCanvas.getContext('2d');
        ctx.clearRect(0, 0, matrixCanvas.width, matrixCanvas.height);
    }

    // startGame fonksiyonunun başında nickname kontrolüyle animasyonu başlat/durdur
    const origStartGame = startGame;
    startGame = function() {
        if (nickname && ['matrix','neo','admin'].includes(nickname.trim().toLowerCase())) {
            startMatrixRain();
        } else {
            stopMatrixRain();
        }
        origStartGame.apply(this, arguments);
    };

    // Oyun bitince veya sayfa kapanınca animasyonu durdur
    window.addEventListener('beforeunload', stopMatrixRain);

    // --- Başlat ---
    loadAssets(() => {
        resizeGameCanvas();
        draw();
    });

    // --- Tam ekran fonksiyonu ---
    // (Kaldırıldı)
    </script>
</body>
</html> 